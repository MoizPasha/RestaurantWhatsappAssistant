<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>n8n Webtrigger Chat</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--accent:#2b7cff;--muted:#6b7280}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0;background:var(--bg);color:#111}
    .wrap{max-width:720px;margin:28px auto;padding:16px}
    .panel{background:var(--card);border-radius:10px;box-shadow:0 6px 20px rgba(15,23,42,.06);overflow:hidden}
    .header{display:flex;gap:8px;padding:12px 14px;border-bottom:1px solid #eef2f7;align-items:center}
    .header input[type=text]{flex:1;padding:8px 10px;border:1px solid #e6e9ef;border-radius:8px}
    .header button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .header .small{font-size:12px;color:var(--muted);margin-left:8px}
    .chat{height:420px;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,#fff, #fbfdff)}
    .msg{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.3}
    .msg.sent{align-self:flex-end;background:linear-gradient(90deg,var(--accent),#1e66d6);color:#fff;border-bottom-right-radius:4px}
    .msg.recv{align-self:flex-start;background:#f1f5f9;color:#0f172a;border-bottom-left-radius:4px}
    .meta{font-size:12px;color:var(--muted);text-align:center;padding:8px 12px}
    .composer{display:flex;gap:8px;padding:12px;border-top:1px solid #eef2f7}
    .composer input[type=text]{flex:1;padding:10px;border:1px solid #e6e9ef;border-radius:8px}
    .composer button{background:#0f172a;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    .smallbtn{background:#fff;border:1px solid #e6e9ef;color:#111;padding:8px 10px;border-radius:8px;cursor:pointer}
    .note{font-size:12px;color:var(--muted);padding:8px 12px}
    .bottom-actions{display:flex;gap:8px;align-items:center}
    pre.small{white-space:pre-wrap;font-size:13px;margin:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="header">
        <input id="webTrigger" type="text" placeholder="Enter n8n webtrigger URL (e.g. https://â€¦/webhook/abcd)" />
        <button id="saveBtn">Set</button>
        <button id="clearBtn" class="smallbtn">Clear</button>
        <div class="small" id="status">Not set</div>
      </div>

      <div id="chat" class="chat" aria-live="polite"></div>

      <div class="composer">
        <input id="messageInput" type="text" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
        <button id="sampleBtn" class="smallbtn">Add incoming</button>
      </div>
      <div class="note">Sending JSON body: <code>{"message": "...", "phone": 1}</code></div>
    </div>
  </div>

  <script>
    const webInput = document.getElementById('webTrigger');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const status = document.getElementById('status');
    const chat = document.getElementById('chat');
    const msgInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const sampleBtn = document.getElementById('sampleBtn');

    // load saved url
    const SAVED_KEY = 'n8n_webtrigger_url_v1';
    function updateStatus() {
      const val = localStorage.getItem(SAVED_KEY);
      status.textContent = val ? 'Set' : 'Not set';
      if (val) webInput.value = val;
    }
    updateStatus();

    saveBtn.addEventListener('click', ()=>{
      const v = webInput.value.trim();
      if (!v) return alert('Enter a valid URL');
      localStorage.setItem(SAVED_KEY, v);
      updateStatus();
    });

    clearBtn.addEventListener('click', ()=>{
      localStorage.removeItem(SAVED_KEY);
      webInput.value = '';
      updateStatus();
    });

    function appendMessage(kind, text) {
      const d = document.createElement('div');
      d.className = 'msg ' + (kind === 'sent' ? 'sent' : 'recv');
      d.textContent = text;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const url = localStorage.getItem(SAVED_KEY) || webInput.value.trim();
      if (!url) return alert('Please set the webtrigger URL first');
      const message = msgInput.value.trim();
      if (!message) return;

      appendMessage('sent', message);
      msgInput.value = '';

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message, phone: 0 })
        });

        // try parse json
        let data;
        try { data = await resp.json(); } catch(e) { data = null; }

        if (!resp.ok) {
          const txt = data && data.message ? data.message : (data ? JSON.stringify(data) : await resp.text());
          appendMessage('recv', 'Error: ' + txt);
          return;
        }

        if (data) {
          if (typeof data === 'string') appendMessage('recv', data);
          else if (data.output) appendMessage('recv', data.output);
          else appendMessage('recv', JSON.stringify(data));
        } else {
          const txt = await resp.text();
          appendMessage('recv', txt || '[no response body]');
        }
      } catch (err) {
        appendMessage('recv', 'Network error: ' + String(err));
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e)=>{ if (e.key === 'Enter') sendMessage(); });

    // helper to quickly add an incoming message (for local testing)
    sampleBtn.addEventListener('click', ()=>{
      const t = prompt('Incoming message text:','Hello from n8n');
      if (t) appendMessage('recv', t);
    });
  </script>
</body>
</html>
